% !TEX root =  UnofficialGuideToNWTC135mData.tex
\chapter{High-frequency time-series data}
High-frequency (20 Hz) time-series data are made available in two forms:
\begin{enumerate}
\item MATLAB structures, and
\item ASCII text files
\end{enumerate}

\section{What data are measured by the towers?}
Data files for the two towers at the National Wind Technology Center (M4 and M5) have different contents. As described in \cite{Clifton_2013_c}, the two towers have slightly different instrumentation, which is reflected in the variable names. The devices used to measure different parameters are listed in Table \ref{table:M4M5devices}. Instrumentation on the different towers is listed in Tables \ref{table:M4heights} (M4) and \ref{table:M5heights} (M5). Channel names are listed in Tables \ref{table:M4channels} and \ref{table:M5channels}.

%%%%%%%%%%%
%% CHANNELS %%
%%%%%%%%%%%
\input{../common/Table_M4M5devices}

\begin{table}
\caption[M4 instrumentation]{Heights of instrumentation on the M4 tower. Parameters are described in more detail in Table \ref{table:M4M5devices}.\label{table:M4heights}\index{instrumentation!M4 tower}}
\input{../common/Table_M4heights}
\end{table}

\begin{table}
\caption[M5 instrumentation]{Heights of instrumentation on the M5 tower. Parameters are described in more detail in Table \ref{table:M4M5devices}.\label{table:M5heights}\index{instrumentation!M5 tower}}
\input{../common/Table_M5heights}
\end{table}

\clearpage

\input{../common/Table_M4DataChannels}

\input{../common/Table_M5DataChannels}

%%%%%%%%%%%%
%% MATLAB 20-Hz %%
%%%%%%%%%%%%

\section{MATLAB 20-Hz files\label{s:HFMatlab}}
The MATLAB 20-Hz file includes all of the time-series (20 Hz) data that were written out from each of the instruments listed in Tables \ref{table:M4heights} (M4) and \ref{table:M5heights} (M5). The file  includes both measurement data and metadata.

\subsection{Loading the data file}
Load the file using MATLAB's \mfunction{load} function. If \mfile{myfile.mat} is the name of the file, use

\begin{lstlisting}
load{myfile}
\end{lstlisting}

\subsection{Data structure}
Each channel is written out into a separate variable. To get a listing of all of the variables in the file, load the file and then use the \mfunction{who} command. The following variables will be listed in the workspace:
\begin{itemize}
\item \mvar{time\_UTC}: the UTC time stamp of the data. This is a MATLAB serial date number, and can be converted to seconds from the start of the file using the following MATLAB code:

\begin{lstlisting}
time_elapsed = (time_UTC.val-time_UTC.val(1))*60*60*24;
\end{lstlisting}

\item \mvar{<Channel\_name>}: Time series data from all channels with all extreme values (i..e at full scale) removed.
\item \mvar{Sonic\_<x,y,z,Temp>\_clean\_<z>m}: Time series data from the sonics with all extreme values and spikes removed. Missing data have been replaced by linearly interpolating. These data should be used together with the time series in \mvar{Sonic\_cleaned\_timestamp}.
\item \mvar{Sonic\_dt\_clean\_<z>m}: time elapsed since the start of the data acquisition [seconds].
\item \mvar{Sonic\_<u,v,w>\_<z>m}: data from the sonic anemometers that have been processed so that they are oriented into the prevailing wind direction during that 10-minute interval. These time series have the property that the mean lateral and vertical velocities ($\overline{v}$ and $\overline{w}$, respectively) are zero. These data should be used together with the time series in \mvar{Sonic\_rotated\_timestamp}.
\item \mvar{Sonic\_Temp\_rotated\_<z>m}: the temperature from the sonic anemometers, at the same temporal resolution as the rotated data.
\end{itemize}

Each variable is a structure\footnote{See documentation from Mathworks, e.g. \url{http://www.mathworks.com/help/techdoc/matlab_prog/br04bw6-38.html}} containing information that help to identify the data. The structure includes:
\begin{itemize}
\item \mvar{.val} All data obtained during the 10-minute interval. For a 10-minute file from instruments that were sampled at 20 Hz, this should include approximately 12,000 samples. There may be less samples if a measurement was skipped.
\item \mvar{.label}. Text string to use as a label for charts, etc.
\item \mvar{.units}. Text string containing a \LaTeX-formatted string describing the units, e.g. \verb+'m s^{-1}'+.
\item \mvar{.height}. The height $z$ above ground [m].
\end{itemize}

To plot the raw, cleaned, and rotated sonic anemometer temperature at 100 m a.g.l., versus the elapsed time since the start of the file, try the following Matlab code:

\begin{lstlisting}
% get the time in seconds that is elapsed since the start of the file
time_elapsed = (time_UTC.val-time_UTC.val(1))*60*60*24;

figure
plot(time_elapsed,Sonic_Temp_100.val,'ko')
hold on
plot(Sonic_dt_clean_100m.val, Sonic_Temp_clean_100m.val,'b+')
plot(Sonic_dt_clean_100m.val,Sonic_Temp_rotated_100m.val,'rx')

legend('Raw data','Cleaned data','Rotated data')
set(legend, 'location', 'best')
\end{lstlisting}

\subsection{Metadata structure\label{s:20HzMetadata}}
The data file also includes a variable called \mvar{tower}. This is a structure containing information (metadata) about the meteorological tower and the data processing. Not all fields are relevant for the end user. For completeness, the following fields are found in the \mvar{tower} structure:

\begin{itemize}
\item \mvar{tower.config.date}: A date array of the last update to the configuration file.
\item \mvar{tower.name}: A name to use for the tower, e.g. `M4'.
\item \mvar{tower.id} A unique identifier for the tower, e.g. `4.4'.
\item \mvar{tower.baseheight}: The height of the tower base above sea level [m], e.g. 1845.
\item \mvar{tower.UTCoffset}: The number of hours offset between the local time zone and UTC, where local = UTC + offset, e.g. -7.
\item \mvar{tower.timezone}: a string identifying the timezone that the tower is operating in, e.g. `MST'.
\item \mvar{tower.daqfreq}: the frequency at which the DAQ is operating [Hz], e.g. 20.
\item \mvar{tower.windowsize}: the number of expected samples per data file, e.g. 12000.
\item \mvar{tower.veldirpairs}: An $m\times 2$ array of channel numbers of wind speed and direction to use to calculate a velocity profile. Each row includes the channel number of a cup and a vane\footnote{Channel numbers are listed in Table \ref{table:M4channels} and \ref{table:M5channels}.}.
\item \mvar{tower.veldetrendingorder}: The order of detrending to use on velocity data to estimate turbulence, e.g. 0 (no detrending).
\item \mvar{tower.thermodynamics}: A structure containing information about the mean thermodynamic properties during the 10 minutes.
\item \mvar{tower.sonicrotationmethod}: A description of the technique used to rotate the sonic anemometer data into the prevailing wind, e.g. `pitchnyaw'.
\item \mvar{tower.sonicdetrendingorder}:  The order of detrending to use on sonic anemometer velocity data to estimate turbulence, e.g. 0 (no detrending).
\item \mvar{tower.sonicinterpmethod}: The method to use to fill gaps in the sonic anemometer time series, e.g. 'linear' for linear interpolation.
\item \mvar{tower.sonicpassrate}: The minimum frequency of good data that is required to calculate statistics from the sonic anemometer data. For example, 0.92 indicates that 92\% of data must be good.
\item \mvar{tower.sonicrotaterate}: The minimum frequency of good data that is required for the sonic anemometer data to be rotated into the prevailing wind. For example, 0.95 indicates that 95\% of data must be good.
\item \mvar{tower.sonictype}: A cell array of strings that describe the sonic anemometers. These can be used to switch between different processing routines for different types of instrument.
\item \mvar{tower.sonicdespike}: A logical array that determines if a sonic anemometer time series should be despiked (true) or not (false), e.g. [1 1 1 1 1 1] means that all sonic anemometers should be despiked.
\item \mvar{tower.sonicpairs}: Channel numbers for the sonic anemometers and accelerometer. Each row includes the $x$, $y$, $z$ velocities and temperature, and the $x$, $y$, and $z$ acceleration.
%\item \mvar{tower.richardsonpairs}: [4x2 double]
\item \mvar{tower.shearpairs}: A cell array of instruments that should be used to calculate a shear exponent from.
\item \mvar{tower.precipsensor}: The channel number of the device that detects precipitation, e.g. 64.
\item \mvar{tower.velprofile}: A list of channels to use to display a velocity profile over.
\item \mvar{tower.tempprofile}: A list of channels to use to display a temperature profile over.
\item \mvar{tower.processing}: A structure containing information about the processing that this file has had.
\item \mvar{tower.outage}: A cell array of structures containing data about known outages on this tower.
\end{itemize}

%%%%%%%%%%%%
%% ASCII DATA %%%
%%%%%%%%%%%%
\newpage
\section{ASCII (text) time series file\label{s:HFASCII}}

\subsection{Loading the data file}
The ASCII time series file can be opened by any program that can read ASCII text. Before opening the file, the reader is recommended to move the file to their own local file space or hard drive.

For simplicity, the following example assumes the reader has access to Microsoft Excel.
\begin{itemize}
\item Open Excel
\item From the 'File' menu, select 'open' and find the file using the browser
\item Follow the prompts to import the data as comma-delimited text
\end{itemize}

Note that alternative approaches such as right-click and 'open with', loading the file directly from the internet, and covering text to data columns, will not work.

\subsection{Data structure}
The ASCII time series file has 3 header lines and then data lines. 

The header files are:
\begin{enumerate}
\item Variable names
\item Units
\item Measurement height [m]
\end{enumerate}

The data lines are comma-separated, fixed width fields. All of the time series data from the individual channels are included, as well as the cleaned and rotated data from the sonic anemometers. The following variables are included:

\begin{itemize}
\item \mvar{time\ (elapsed)}: time since the start of the data acquisition [seconds].
\item \mvar{<Channel\_name>}: Time series data from all channels with all extreme values (i..e at full scale) removed.
\item \mvar{Sonic\_<x,y,z,Temp>\_clean\_<z>m}: Time series data from the sonics with all extreme values and spikes removed. Missing data have been replaced by linearly interpolating. These data should be used together with the time series in \mvar{Sonic\_cleaned\_timestamp}.
\item \mvar{Sonic\_cleaned\_timestamp}: time elapsed since the start of the data acquisition [seconds].
\item \mvar{Sonic\_<u,v,w>\_<z>m}: data from the sonic anemometers that have been processed so that they are oriented into the prevailing wind direction during that 10-minute interval. These time series have the property that the mean lateral and vertical velocities ($\overline{v}$ and $\overline{w}$, respectively) are zero. These data should be used together with the time series in \mvar{Sonic\_rotated\_timestamp}.
\item \mvar{Sonic\_Temp\_rotated\_<z>m}: the temperature from the sonic anemometers, at the same temporal resolution as the rotated data.
\item \mvar{Sonic\_rotated\_timestamp}: time elapsed since the start of the data acquisition [seconds].
\end{itemize}