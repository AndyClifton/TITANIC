% function MainTowerOperational
%
% Identify and anlyse data files generated by the NWTC Met towers in the
% last 24 hours.
%
% Written by Andy Clifton, July 2011.

function [from_date,to_date,data_path] = MainTowerOperational(varargin)

%% check the input data
optargin = size(varargin,2);
switch optargin
	case 0
        % assume we are running on M4 and we need this doing now
		tower = 'M4';
		from_date = datevec(SubNowUTC(-7)-2/24);
		to_date = datevec(SubNowUTC(-7)+1/24);
		DO_MOVE = 1;    % move data to show what the recent results look like
	otherwise
		% there are optional arguments
		% assume that we don't give a date, but pick this up if we do
		DO_MOVE =1;
		for k= 1:2:size(varargin,2)
			if isdeployed
				switch varargin{k}
					case {'from_date';'to_date'}
						eval([char(varargin{k}) '= str2num(varargin{' num2str(k+1) '});']);
						DO_MOVE = 0;
					otherwise
						eval([char(varargin{k}) '= varargin{' num2str(k+1) '};']);
				end
			else
				switch varargin{k}
					case {'from_date';'to_date'}
						DO_MOVE = 0;
				end
				if isnumeric(varargin{k+1})
					eval([char(varargin{k}) '= varargin{' num2str(k+1) '};']);
				elseif ischar(varargin{k+1})
					eval([char(varargin{k}) '=''' char(varargin{k+1}) ''';']);
				end
				
			end
		end
end

%% check to see if we set all the things we need
if ~exist('from_date','var')
    % assume we need this doing now
	from_date = datevec(SubNowUTC(-7)-2/24);
end
if ~exist('to_date','var')
	to_date = datevec(SubNowUTC(-7)+1/24);
end
if ~exist('from_date','var') & ~exist('to_date','var')
	DO_MOVE = 1;
end

if ~exist('tower','var')
	tower = 'M4';
	towerdata_path_default = 'M4Twr';
	outage_file_default = 'M4_outages.mat';
	config_file_default = 'M4_config.mat';
else
	switch tower
		case 'M4'
			towerdata_path_default = 'M4Twr';
			outage_file_default = 'M4_outages.mat';
			config_file_default = 'M4_config.mat';
		case 'M5'
			towerdata_path_default = 'M5Twr';
			outage_file_default = 'M5_outages.mat';
			config_file_default = 'M5_config.mat';
	end
end

if ~exist('data_path','var')
	% data path
	if ispc
		data_root_default = ['Y:\Wind\Confidential\Projects\MetData\' towerdata_path_default '\'];
		data_path_default = [data_root_default datestr(datenum(from_date),'yyyy\\mm')];
	elseif ismac
		data_root_default = ['/Volumes/Confidential/Projects/MetData/' towerdata_path_default '/'];
		data_path_default = [data_root_default datestr(datenum(from_date),'yyyy/mm')];
	end
	data_root = data_root_default;
	data_path = data_path_default;
end

% hostname
hostname = SubGetHostname;

% log file name
if ~exist('log_file','var')
	if isdeployed
		log_file_default = [tower '_log_operational_' strrep(hostname,'.','_') '.txt'];
	else
		log_file_default = [tower '_log_interactive_' strrep(hostname,'.','_') '.txt'];
	end
	log_file = log_file_default;
end

% log path name
if ~exist('log_path','var')
	if ispc
		log_path_default = ['Y:\Wind\Confidential\Projects\MetData\' towerdata_path_default '\QCReports'];
	elseif ismac
		log_path_default = ['/Volumes/Confidential/Projects/MetData/' towerdata_path_default '/QCReports'];
	end
	log_path = log_path_default;
end

% outage file name
if ~exist('outage_file','var')
	outage_file = outage_file_default;
end

% outage path
if ~exist('outage_path','var')
	if ispc
		outage_path_default = 'Y:\wind\public\Projects\Projects G-S\Met135Analysis\firstlook';
	elseif ismac
		outage_path_default = '/Volumes/Public/Projects/Projects G-S/Met135Analysis/firstlook';
	end
	outage_path = outage_path_default;
end

%% config file
% file name
if ~exist('config_file','var')
	config_file = config_file_default;
end

% configuration path
if ~exist('config_path','var')
	if ispc
		config_path_default = 'Y:\wind\public\Projects\Projects G-S\Met135Analysis\firstlook';
	elseif ismac
		config_path_default = '/Volumes/Public/Projects/Projects G-S/Met135Analysis/firstlook';
	end
	config_path = config_path_default;
end

%% Web page

% log path name
if ~exist('web_path','var')
	switch tower
		case {'M4';'M5'}
			if ispc
				web_path_default = ['Y:\Wind\WindWeb\MetData\' towerdata_path_default ''];
			elseif ismac
				web_path_default = ['/Volumes/WindWeb/MetData/' towerdata_path_default ''];
			end
		otherwise
			web_path_default = '';
	end
	web_path = web_path_default;
end

%% ------
% RUN!!
% -------
MainTower;
